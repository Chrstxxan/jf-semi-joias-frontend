<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meus Pedidos - JF Semi Joias</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Meus Pedidos</h1>
    <p>Acompanhe seus pedidos e status de entrega</p>
    <button id="botao-carrinho" onclick="window.location.href='carrinho.html'">
      <img src="./icons/cart.svg" alt="Carrinho">
      <span id="contador-carrinho">0</span>
    </button>
  </header>

  <!-- Bolhas laterais -->
  <div id="bolhas-menu">
    <button class="bolha" id="botao-login" title="Conta"><img src="icons/user.svg" alt="Login"></button>
    <button class="bolha" id="botao-pedidos" title="Meus Pedidos"><img src="icons/box.svg" alt="Pedidos"></button>
    <button class="bolha" id="botao-favoritos" title="Favoritos"><img src="icons/star.svg" alt="Favoritos"></button>
  </div>

  <main id="pedidos-container">
    <h2>Histórico de Pedidos</h2>
    <div id="lista-pedidos"><p>Carregando seus pedidos...</p></div>
  </main>

  <footer><p>© 2025 JF Semi Joias - Todos os direitos reservados</p></footer>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const API_URL = "https://jf-semi-joias-backend.onrender.com";

    // ================================
    // 🛒 Atualiza contador do carrinho
    // ================================
    function atualizarContadorCarrinho() {
      const carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
      document.getElementById('contador-carrinho').textContent = carrinho.length;
    }

    // ================================
    // 💡 Inicializa botões flutuantes
    // ================================
    function inicializarBolhas() {
      document.getElementById('botao-login')?.addEventListener('click', () => {
        const token = localStorage.getItem('token');
        if (token) {
          Swal.fire({
            icon: 'info',
            title: 'Você já está logado',
            text: 'Deseja sair da conta?',
            showCancelButton: true,
            confirmButtonText: 'Sair',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#ff6fa7'
          }).then(r => {
            if (r.isConfirmed) {
              localStorage.removeItem('token');
              Swal.fire('Sessão encerrada!', '', 'success').then(() => location.reload());
            }
          });
        } else {
          window.location.href = 'login.html';
        }
      });

      document.getElementById('botao-pedidos')?.addEventListener('click', () => window.location.href = 'meus-pedidos.html');
      document.getElementById('botao-favoritos')?.addEventListener('click', () => window.location.href = 'favoritos.html');
    }

    // ================================
    // 📦 Carrega pedidos do usuário logado
    // ================================
    async function carregarPedidos() {
      const lista = document.getElementById('lista-pedidos');
      const token = localStorage.getItem('token');
      atualizarContadorCarrinho();

      if (!token) {
        lista.innerHTML = `
          <p>Faça login para visualizar seus pedidos.</p>
          <button onclick="window.location.href='login.html'">Fazer Login</button>
        `;
        return;
      }

      try {
        const res = await fetch(`${API_URL}/orders`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("Erro na API");
        const pedidos = await res.json();

        if (!Array.isArray(pedidos) || pedidos.length === 0) {
          lista.innerHTML = '<p>Você ainda não possui pedidos.</p>';
          return;
        }

        // 🔁 Traduz status para português
        const traduzirStatus = (status) => {
          const mapa = {
            pending: "Pendente",
            approved: "Pago",
            rejected: "Rejeitado",
            pendente: "Pendente",
            pago: "Pago",
            rejeitado: "Rejeitado",
            enviado: "Enviado",
            entregue: "Entregue",
            cancelado: "Cancelado"
          };
          return mapa[status] || "Em processamento";
        };

        lista.innerHTML = pedidos.map(p => `
          <div class="pedido-card" style="border:1px solid #ddd;border-radius:10px;padding:20px;margin-bottom:20px;background:#fffafc;">
            <h3 style="color:#ff6fa7;">Pedido #${p._id.slice(-6).toUpperCase()}</h3>
            <p><b>Status:</b> ${traduzirStatus(p.status)} — <b>Pagamento:</b> ${traduzirStatus(p.statusPagamento)}</p>
            <p><b>Data:</b> ${new Date(p.criadoEm).toLocaleString('pt-BR')}</p>
            <p><b>Total:</b> R$ ${p.total?.toFixed(2) || '0,00'}</p>

            ${
              p.enderecoEntrega
                ? `<p><b>Entrega:</b> ${p.enderecoEntrega.rua || ''}, ${p.enderecoEntrega.numero || ''} - ${p.enderecoEntrega.bairro || ''}, ${p.enderecoEntrega.cidade || ''}/${p.enderecoEntrega.uf || ''}</p>`
                : ''
            }

            ${
              p.rastreio
                ? `<p><b>Rastreio:</b> <a target="_blank" href="https://rastreamento.correios.com.br/app/index.php">${p.rastreio}</a></p>`
                : `<p><b>Rastreio:</b> —</p>`
            }

            <details style="margin-top:10px;">
              <summary style="cursor:pointer;color:#ff6fa7;font-weight:bold;">Ver itens</summary>
              <div style="margin-top:10px;">
                ${p.produtos.map(item => `
                  <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                    <img src="${item.imagem || './img/semfoto.png'}" alt="${item.nome}" width="50" style="border-radius:5px;" />
                    <span>${item.nome}</span>
                    <small>Qtd: ${item.quantidade}</small>
                  </div>
                `).join('')}
              </div>
            </details>
          </div>
        `).join('');
      } catch (e) {
        console.error('Erro ao carregar pedidos:', e);
        lista.innerHTML = '<p>Erro ao carregar pedidos 😥</p>';
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      inicializarBolhas();
      carregarPedidos();
    });
  </script>
</body>
</html>
