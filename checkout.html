<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - JF Semi Joias</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ðŸ’… Estilo aprimorado do frete */
    #frete-info {
      font-weight: 600;
      color: #333;
      margin-top: 10px;
      font-size: 1rem;
    }

    #frete-info span.prazo {
      color: #ff6fa7;
      font-style: italic;
      font-weight: 500;
      margin-left: 5px;
    }

    /* ðŸ’³ BotÃ£o de pagamento com Ã­cones */
    #btn-pagar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background-color: #ff6fa7;
      border: none;
      color: #fff;
      font-size: 1.1rem;
      font-weight: 600;
      padding: 15px 25px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    #btn-pagar:hover {
      background-color: #ff5c98;
      transform: scale(1.02);
    }

    #btn-pagar img {
      width: 22px;
      height: 22px;
      filter: brightness(0) invert(1);
    }

    .item-carrinho {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      padding: 8px 0;
    }
    .item-carrinho img {
      border-radius: 8px;
    }
    .item-carrinho span {
      flex: 1;
      font-weight: 500;
    }
    .item-carrinho small {
      color: #666;
    }
  </style>
</head>

<body>
  <!-- ðŸ” Header padrÃ£o -->
  <nav id="faixa-categorias">
    <div class="categorias">
      <a href="#" class="categoria">Conjuntos</a>
      <a href="#" class="categoria">Pulseiras</a>
      <a href="#" class="categoria">Brincos</a>
      <a href="#" class="categoria">AnÃ©is</a>
    </div>


    <div class="busca">
      <input type="text" placeholder="Digite aqui o que procura..." />
      <button id="botao-buscar">
        <img src="./icons/search.svg" width="20" alt="Buscar" />
      </button>
    </div>
  </nav>

  <header>
    <h1>Finalizar Compra</h1>
    <p>Confira seus dados e o endereÃ§o de entrega</p>
  </header>

  <main id="checkout-container">
    <!-- ðŸ“¦ EndereÃ§o e dados pessoais -->
    <section id="endereco">
      <h2>EndereÃ§o de Entrega</h2>
      <form id="form-endereco">
        <input type="text" id="nome" placeholder="Nome completo" required />
        <input type="tel" id="telefone" placeholder="Telefone (com DDD)" required maxlength="15" />
        <input type="text" id="cep" placeholder="CEP" required maxlength="9" />
        <input type="text" id="rua" placeholder="Rua" required />
        <input type="text" id="numero" placeholder="NÃºmero" required />
        <input type="text" id="complemento" placeholder="Complemento" />
        <input type="text" id="bairro" placeholder="Bairro" required />
        <input type="text" id="cidade" placeholder="Cidade" required />
        <input type="text" id="uf" placeholder="UF" maxlength="2" required />

        <button type="button" id="calcular-frete">Calcular Frete</button>
      </form>

      <div id="resultado-frete" style="margin-top: 15px;"></div>
    </section>

    <!-- ðŸ§¾ Resumo do pedido -->
    <section id="resumo-pedido">
      <h2>Resumo do Pedido</h2>
      <div id="lista-produtos"></div>
      <h3 id="total-pedido">Total: R$ 0,00</h3>
      <h3 id="frete-info"></h3>
      <h2 id="total-geral"></h2>
    </section>

    <!-- ðŸ’³ BotÃ£o de pagamento com Ã­cones -->
    <button id="btn-pagar" disabled>
      <img src="./icons/card.svg" alt="Ãcone cartÃ£o" />
      Pagar com Mercado Pago
      <img src="./icons/card.svg" alt="Ãcone cartÃ£o" />
    </button>
  </main>

  <footer>
    <p>Â© 2025 JF Semi Joias - Todos os direitos reservados</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const API = "https://jf-semi-joias-backend.onrender.com";
    const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    const token = localStorage.getItem("token");

    let valorFrete = 0;
    let totalProdutos = carrinho.reduce((s, p) => s + (p.preco * (p.quantidade || 1)), 0);

    // ================================
    // ðŸ§º Carrega resumo do carrinho
    // ================================
    function carregarResumo() {
      const lista = document.getElementById("lista-produtos");

      if (!carrinho.length) {
        lista.innerHTML = "<p>Seu carrinho estÃ¡ vazio.</p>";
        document.getElementById("btn-pagar").disabled = true;
        return;
      }

      lista.innerHTML = carrinho.map(p => `
        <div class="item-carrinho">
          <img src="${p.imagem}" alt="${p.nome}" width="60" />
          <div>
            <span>${p.nome}</span>
            ${p.tamanho ? `<p><b>Tamanho:</b> ${p.tamanho}</p>` : ""}
            <small>R$ ${p.preco.toFixed(2)}</small>
          </div>
        </div>
      `).join("");

      document.getElementById("total-pedido").textContent =
        `Total produtos: R$ ${totalProdutos.toFixed(2)}`;
    }

    // ================================
    // ðŸ” Busca endereÃ§o via CEP (ViaCEP)
    // ================================
    document.getElementById("cep").addEventListener("blur", async () => {
      const cep = document.getElementById("cep").value.replace(/\D/g, "");
      if (cep.length !== 8) return;

      try {
        const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await res.json();
        if (data.erro) throw new Error("CEP nÃ£o encontrado");

        document.getElementById("rua").value = data.logradouro;
        document.getElementById("bairro").value = data.bairro;
        document.getElementById("cidade").value = data.localidade;
        document.getElementById("uf").value = data.uf;
      } catch {
        Swal.fire({
          icon: "error",
          title: "CEP invÃ¡lido",
          confirmButtonColor: "#ff6fa7"
        });
      }
    });

    // ================================
    // ðŸšš Calcular frete
    // ================================
    document.getElementById("calcular-frete").addEventListener("click", async () => {
      const cepDestino = document.getElementById("cep").value.replace(/\D/g, "");
      if (!cepDestino) {
        Swal.fire({ icon: "warning", title: "Informe o CEP", confirmButtonColor: "#ff6fa7" });
        return;
      }

      try {
        const res = await fetch(`${API}/frete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cepDestino })
        });

        const data = await res.json();
        valorFrete = parseFloat(data.Valor.replace(",", ".")) || 0;

        document.getElementById("frete-info").innerHTML =
          `Frete: R$ ${valorFrete.toFixed(2)} <span class="prazo">(${data.PrazoMedio} a ${data.PrazoMaximo} dias Ãºteis)</span>`;

        document.getElementById("total-geral").textContent =
          `Total com frete: R$ ${(totalProdutos + valorFrete).toFixed(2)}`;

        document.getElementById("btn-pagar").disabled = false;
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: "error",
          title: "Erro ao calcular frete",
          text: "Tente novamente mais tarde.",
          confirmButtonColor: "#ff6fa7"
        });
      }
    });

    // ================================
    // ðŸ’³ Pagar com Mercado Pago
    // ================================
    document.getElementById("btn-pagar").addEventListener("click", async () => {
      const enderecoEntrega = {
        nome: document.getElementById("nome").value,
        telefone: document.getElementById("telefone").value,
        cep: document.getElementById("cep").value,
        rua: document.getElementById("rua").value,
        numero: document.getElementById("numero").value,
        complemento: document.getElementById("complemento").value,
        bairro: document.getElementById("bairro").value,
        cidade: document.getElementById("cidade").value,
        uf: document.getElementById("uf").value,
      };

      if (!enderecoEntrega.nome || !enderecoEntrega.telefone || !enderecoEntrega.rua) {
        Swal.fire({
          icon: "warning",
          title: "Preencha todos os campos obrigatÃ³rios!",
          confirmButtonColor: "#ff6fa7"
        });
        return;
      }

      try {
        const res = await fetch(`${API}/payment/mp/preference`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            itens: carrinho.map(p => ({
              produtoId: p._id,
              quantidade: p.quantidade || 1,
              tamanho: p.tamanho || null // ðŸ‘ˆ Envia o tamanho do anel
            })),
            enderecoEntrega,
            frete: valorFrete
          })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.erro || "Erro ao criar pagamento");

        localStorage.removeItem("carrinho");
        window.location.href = data.init_point;
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: "error",
          title: "Erro ao iniciar pagamento",
          text: err.message || "Tente novamente mais tarde.",
          confirmButtonColor: "#ff6fa7",
        });
      }
    });

    // ================================
    // ðŸš€ Inicializa resumo
    // ================================
    window.addEventListener("DOMContentLoaded", carregarResumo);
  </script>
</body>
</html>
