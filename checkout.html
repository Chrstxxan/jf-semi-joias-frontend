<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - JF Semi Joias</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header>
    <h1>Finalizar Compra</h1>
    <p>Confira seus dados e o endereÃ§o de entrega</p>
  </header>

  <main id="checkout-container">
    <section id="endereco">
  <h2>EndereÃ§o de Entrega</h2>
  <form id="form-endereco">
    <input type="text" id="cep" placeholder="CEP" required maxlength="9" />
    <input type="text" id="rua" placeholder="Rua" required />
    <input type="text" id="numero" placeholder="NÃºmero" required />
    <input type="text" id="complemento" placeholder="Complemento" />
    <input type="text" id="bairro" placeholder="Bairro" required />
    <input type="text" id="cidade" placeholder="Cidade" required />
    <input type="text" id="uf" placeholder="UF" maxlength="2" required />

    <button type="button" id="calcular-frete">Calcular Frete</button>
  </form>

  <div id="resultado-frete" style="margin-top: 15px;"></div>
</section>

    <section id="resumo-pedido">
      <h2>Resumo do Pedido</h2>
      <div id="lista-produtos"></div>
      <h3 id="total-pedido">Total: R$ 0,00</h3>
      <h3 id="frete-info"></h3>
      <h2 id="total-geral"></h2>
    </section>

    <button id="btn-pagar" disabled>Pagar com Mercado Pago ðŸ’³</button>
  </main>

  <footer>
    <p>Â© 2025 JF Semi Joias - Todos os direitos reservados</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const API = "http://localhost:5000";
    const pedido = JSON.parse(localStorage.getItem("pedidoAtual"));
    const token = localStorage.getItem("token");

    let valorFrete = 0;
    let totalProdutos = pedido?.total || 0;

    // ================================
    // Preenche resumo do pedido
    // ================================
    function carregarResumo() {
      const lista = document.getElementById("lista-produtos");
      if (!pedido || !pedido.produtos) {
        lista.innerHTML = "<p>Nenhum item encontrado.</p>";
        return;
      }

      lista.innerHTML = pedido.produtos.map(p => `
        <div class="item-carrinho">
          <img src="${p.imagem}" alt="${p.nome}" width="60" />
          <span>${p.nome}</span>
          <small>R$ ${p.preco.toFixed(2)}</small>
        </div>
      `).join("");

      document.getElementById("total-pedido").textContent = `Total produtos: R$ ${totalProdutos.toFixed(2)}`;
    }

    // ================================
    // Busca endereÃ§o pelo CEP (ViaCEP)
    // ================================
    document.getElementById("cep").addEventListener("blur", async () => {
      const cep = document.getElementById("cep").value.replace(/\D/g, "");
      if (cep.length !== 8) return;

      try {
        const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await res.json();
        if (data.erro) throw new Error("CEP nÃ£o encontrado");

        document.getElementById("rua").value = data.logradouro;
        document.getElementById("bairro").value = data.bairro;
        document.getElementById("cidade").value = data.localidade;
        document.getElementById("uf").value = data.uf;
      } catch {
        Swal.fire({
          icon: "error",
          title: "CEP invÃ¡lido",
          confirmButtonColor: "#ff6fa7"
        });
      }
    });

    // ================================
    // Calcula o frete
    // ================================
    document.getElementById("calcular-frete").addEventListener("click", async () => {
      const cepDestino = document.getElementById("cep").value.replace(/\D/g, "");
      if (!cepDestino) {
        Swal.fire({ icon: "warning", title: "Informe o CEP", confirmButtonColor: "#ff6fa7" });
        return;
      }

      try {
        const res = await fetch(`${API}/frete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cepDestino })
        });

        const data = await res.json();
        valorFrete = parseFloat(data.Valor.replace(",", ".")) || 0;

        document.getElementById("frete-info").textContent = `Frete: R$ ${valorFrete.toFixed(2)} (${data.PrazoEntrega} dias Ãºteis)`;
        document.getElementById("total-geral").textContent = `Total com frete: R$ ${(totalProdutos + valorFrete).toFixed(2)}`;
        document.getElementById("btn-pagar").disabled = false;
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: "error",
          title: "Erro ao calcular frete",
          text: "Tente novamente mais tarde.",
          confirmButtonColor: "#ff6fa7"
        });
      }
    });

    // ================================
    // Pagar com Mercado Pago (Sandbox)
    // ================================
    document.getElementById("btn-pagar").addEventListener("click", async () => {
  const enderecoEntrega = {
    cep: document.getElementById("cep").value,
    rua: document.getElementById("rua").value,
    numero: document.getElementById("numero").value,
    complemento: document.getElementById("complemento").value,
    bairro: document.getElementById("bairro").value,
    cidade: document.getElementById("cidade").value,
    uf: document.getElementById("uf").value,
  };

  const token = localStorage.getItem("token");
  const pedido = JSON.parse(localStorage.getItem("pedidoAtual"));
  const itens = pedido?.produtos || [];

  try {
    const res = await fetch(`${API}/payment/mp/preference`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    Authorization: `Bearer ${token}`,
  },
  body: JSON.stringify({
    itens: pedido.produtos.map(p => ({
  produtoId: p.produtoId || p._id,
  quantidade: p.quantidade || 1
})),
    enderecoEntrega: endereco,
    frete: valorFrete
  })
});

    const data = await res.json();
    if (!res.ok) throw new Error(data.erro || "Erro ao criar pagamento");

    window.location.href = data.init_point; // Redireciona pro checkout do Mercado Pago
  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: "error",
      title: "Erro ao iniciar pagamento",
      text: "Tente novamente mais tarde.",
      confirmButtonColor: "#ff6fa7",
    });
  }
});


    // ================================
    // Inicializa
    // ================================
    window.addEventListener("DOMContentLoaded", carregarResumo);
  </script>
</body>
</html>
