<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - JF Semi Joias</title>
  <link rel="stylesheet" href="style.css" />
  <!-- ‚úÖ FAVICON E ICONES PWA -->
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
  <link rel="manifest" href="icons/site.webmanifest">
  <link rel="shortcut icon" href="icons/favicon.ico" type="image/x-icon">
  <style>
    /* üíÖ Estilo aprimorado do frete */
    #frete-info {
      font-weight: 600;
      color: #333;
      margin-top: 10px;
      font-size: 1rem;
    }

    #frete-info span.prazo {
      color: #ff6fa7;
      font-style: italic;
      font-weight: 500;
      margin-left: 5px;
    }

    /* üí≥ Bot√£o de pagamento com √≠cones */
    #btn-pagar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background-color: #ff6fa7;
      border: none;
      color: #fff;
      font-size: 1.1rem;
      font-weight: 600;
      padding: 15px 25px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    #btn-pagar:hover {
      background-color: #ff5c98;
      transform: scale(1.02);
    }

    #btn-pagar img {
      width: 22px;
      height: 22px;
      filter: brightness(0) invert(1);
    }

    .item-carrinho {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      padding: 8px 0;
    }
    .item-carrinho img {
      border-radius: 8px;
    }
    .item-carrinho span {
      flex: 1;
      font-weight: 500;
    }
    .item-carrinho small {
      color: #666;
    }
  </style>
</head>

<body>
      <div id="faixa-bf">
  <img src="./icons/confetti.svg" class="icon-bf" alt="">
  <div class="texto-bf">
    <span class="titulo">Esquenta Black Friday:</span>
    <span class="sub">Todo o site com 20% de desconto</span>
  </div>
  <img src="./icons/confetti.svg" class="icon-bf" alt="">
</div>
  <!-- üîù Header padr√£o -->
  <nav id="faixa-categorias">
    <div class="categorias">
      <a href="index.html" class="categoria inicio">In√≠cio</a>
      <span class="divisor">|</span>

      <div class="dropdown">
        <button class="dropbtn">Categorias</button>
        <div class="dropdown-content">
          <a href="#" class="categoria">Conjuntos</a>
          <a href="#" class="categoria">An√©is</a>
          <a href="#" class="categoria">Brincos</a>
          <a href="#" class="categoria">Pulseiras</a>
          <a href="#" class="categoria">Correntes</a>
        </div>
      </div>
    </div>

    <div class="busca">
      <input type="text" placeholder="Digite aqui o que procura..." />
      <button id="botao-buscar" title="Buscar">
        <img src="./icons/search.svg" width="20" alt="Buscar" />
      </button>
    </div>
  </nav>

  <header>
    <h1>Finalizar Compra</h1>
    <p>Confira seus dados e o endere√ßo de entrega</p>
  </header>

  <main id="checkout-container">
    <!-- üì¶ Endere√ßo e dados pessoais -->
    <section id="endereco">
      <h2>Endere√ßo de Entrega</h2>
      <form id="form-endereco">
        <input type="text" id="nome" placeholder="Nome completo" required />
        <input type="tel" id="telefone" placeholder="Telefone (com DDD)" required maxlength="15" />
        <input type="text" id="cep" placeholder="CEP" required maxlength="9" />
        <input type="text" id="rua" placeholder="Rua" required />
        <input type="text" id="numero" placeholder="N√∫mero" required />
        <input type="text" id="complemento" placeholder="Complemento" />
        <input type="text" id="bairro" placeholder="Bairro" required />
        <input type="text" id="cidade" placeholder="Cidade" required />
        <input type="text" id="uf" placeholder="UF" maxlength="2" required />

        <button type="button" id="calcular-frete">Calcular Frete</button>
      </form>

      <div id="resultado-frete" style="margin-top: 15px;"></div>
    </section>

    <!-- üßæ Resumo do pedido -->
    <section id="resumo-pedido">
      <h2>Resumo do Pedido</h2>
      <div id="lista-produtos"></div>
      <h3 id="total-pedido">Total: R$ 0,00</h3>
      <h3 id="frete-info"></h3>
      <h2 id="total-geral"></h2>
    </section>

    <!-- üí≥ Bot√£o de pagamento com √≠cones -->
    <button id="btn-pagar" disabled>
      <img src="./icons/card.svg" alt="√çcone cart√£o" />
      Ir para p√°gina de pagamento
      <img src="./icons/card.svg" alt="√çcone cart√£o" />
    </button>
  </main>

  <footer>
    <p>¬© 2025 JF Semi Joias - Todos os direitos reservados</p>
  </footer>

  <script src="authFetch.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- ESQUENTA BF -->
  <script src="promo.js"></script>
  <script>
    window.API = window.API || "https://jf-semi-joias-backend.onrender.com";
    const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
    const token = localStorage.getItem("token");

    let valorFrete = 0;
    /////////////////////// - REMOVER AP√ìS O FIM DA BF
    // IN√çCIO BLACK FRIDAY ‚Äì helper de desconto
    ///////////////////////
    function aplicarDesconto(preco) {
      if (!window.PROMO?.active) return preco;

      const final = preco * (1 - window.PROMO.discountPercentage / 100);
      return Number(final.toFixed(2));
    }
    ///////////////////////
    // FIM BLACK FRIDAY
    ///////////////////////

    let totalProdutos = carrinho.reduce((s, p) => {
      ///////////////////////////////
      // IN√çCIO BLACK FRIDAY ‚Äì total com desconto
      ///////////////////////////////
      const precoComDesconto = window.aplicarDesconto
        ? window.aplicarDesconto(p.preco)
        : p.preco;
      const subtotal = precoComDesconto * (p.quantidade || 1);
      return s + subtotal;
      ///////////////////////////////
      // FIM BLACK FRIDAY
      ///////////////////////////////
    }, 0);

    // ================================
    // üß∫ Carrega resumo do carrinho
    // ================================
    function carregarResumo() {
      const lista = document.getElementById("lista-produtos");

      if (!carrinho.length) {
        lista.innerHTML = "<p>Seu carrinho est√° vazio.</p>";
        document.getElementById("btn-pagar").disabled = true;
        return;
      }

      lista.innerHTML = carrinho.map(p => `
        <div class="item-carrinho">
          <img src="${p.imagem}" alt="${p.nome}" width="60" />
          <div>
            <span>${p.nome}</span>
            ${p.tamanho ? `<p><b>Tamanho:</b> ${p.tamanho}</p>` : ""}
            ${window.PROMO?.active
  ? `
      <small><b>R$ ${aplicarDesconto(p.preco).toFixed(2)}</b></small>
      <br>
      <small style="color:#999;text-decoration:line-through;">
        De R$ ${p.preco.toFixed(2)}
      </small>
    `
  : `
      <small>R$ ${p.preco.toFixed(2)}</small>
    `
}

          </div>
        </div>
      `).join("");


      document.getElementById("total-pedido").textContent =
        `Total produtos: R$ ${totalProdutos.toFixed(2)}`;

      ///////////////////////////////
      // IN√çCIO BLACK FRIDAY ‚Äì mostrar riscado
      ///////////////////////////////
      if (window.PROMO?.active) {
        const totalOriginal = carrinho.reduce(
          (s, p) => s + p.preco * (p.quantidade || 1),
          0
        );

        document.getElementById("total-pedido").innerHTML =
          `Total produtos: <b>R$ ${totalProdutos.toFixed(2)}</b>
          <br><small style="color:#999;text-decoration:line-through">
            De R$ ${totalOriginal.toFixed(2)}
          </small>`;
      }
      ///////////////////////////////
      // FIM BLACK FRIDAY
      ///////////////////////////////
    }

    // ================================
    // üîç Busca endere√ßo via CEP (ViaCEP)
    // ================================
    document.getElementById("cep").addEventListener("blur", async () => {
      const cep = document.getElementById("cep").value.replace(/\D/g, "");
      if (cep.length !== 8) return;

      try {
        const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await res.json();
        if (data.erro) throw new Error("CEP n√£o encontrado");

        document.getElementById("rua").value = data.logradouro;
        document.getElementById("bairro").value = data.bairro;
        document.getElementById("cidade").value = data.localidade;
        document.getElementById("uf").value = data.uf;
      } catch {
        Swal.fire({
          icon: "error",
          title: "CEP inv√°lido",
          confirmButtonColor: "#ff6fa7"
        });
      }
    });

    // ================================
    // üöö Calcular frete
    // ================================
    document.getElementById("calcular-frete").addEventListener("click", async () => {
      const cepDestino = document.getElementById("cep").value.replace(/\D/g, "");
      if (!cepDestino) {
        Swal.fire({ icon: "warning", title: "Informe o CEP", confirmButtonColor: "#ff6fa7" });
        return;
      }

      try {
        const res = await fetch(`${API}/frete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cepDestino })
        });

        const data = await res.json();
        valorFrete = parseFloat(data.Valor.replace(",", ".")) || 0;

        /////////////////////// - REMOVER LOGO AP√ìS A BF
        // IN√çCIO BLACK FRIDAY ‚Äì frete gr√°tis
        ///////////////////////
        if (window.PROMO?.active && window.PROMO.freeShipping) {
          console.log("üöö Frete gr√°tis ativado pela Black Friday!");
          valorFrete = 0;
        }
        ///////////////////////
        // FIM BLACK FRIDAY
        ///////////////////////

        document.getElementById("frete-info").innerHTML =
          `Frete: R$ ${valorFrete.toFixed(2)} <span class="prazo">(${data.PrazoMedio} a ${data.PrazoMaximo} dias √∫teis)</span>`;

        document.getElementById("total-geral").textContent =
          `Total com frete: R$ ${(totalProdutos + valorFrete).toFixed(2)}`;

        document.getElementById("btn-pagar").disabled = false;
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: "error",
          title: "Erro ao calcular frete",
          text: "Tente novamente mais tarde.",
          confirmButtonColor: "#ff6fa7"
        });
      }
    });

    // ================================
    // üí≥ Pagar com Mercado Pago
    // ================================
    document.getElementById("btn-pagar").addEventListener("click", async () => {

      await refreshToken();
      
      const enderecoEntrega = {
        nome: document.getElementById("nome").value,
        telefone: document.getElementById("telefone").value,
        cep: document.getElementById("cep").value,
        rua: document.getElementById("rua").value,
        numero: document.getElementById("numero").value,
        complemento: document.getElementById("complemento").value,
        bairro: document.getElementById("bairro").value,
        cidade: document.getElementById("cidade").value,
        uf: document.getElementById("uf").value,
      };

      if (!enderecoEntrega.nome || !enderecoEntrega.telefone || !enderecoEntrega.rua) {
        Swal.fire({
          icon: "warning",
          title: "Preencha todos os campos obrigat√≥rios!",
          confirmButtonColor: "#ff6fa7"
        });
        return;
      }

      /////////////////////// - REMOVER AP√ìS O FIM DA BF  
      // IN√çCIO BLACK FRIDAY ‚Äì garantir frete 0
      ///////////////////////
      const freteFinalParaEnvio = (window.PROMO?.active && window.PROMO.freeShipping)
        ? 0
        : valorFrete;
      ///////////////////////
      // FIM BLACK FRIDAY
      ///////////////////////

      try {
        const res = await authFetch(`${API}/payment/mp/preference`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            itens: carrinho.map(p => ({
            produtoId: p._id,
            quantidade: p.quantidade || 1,
            tamanho: p.tamanho || null,
            preco: window.PROMO?.active
              ? aplicarDesconto(p.preco)
              : p.preco
          })),
            enderecoEntrega,
            frete: freteFinalParaEnvio // mudar de volta para valorFrete ap√≥s a bf
          })
        });

        if (!res) return;

        const data = await res.json();
        if (!res.ok) throw new Error(data.erro || "Erro ao criar pagamento");

        localStorage.removeItem("carrinho");
        window.location.href = data.init_point;
      } catch (err) {
        console.error(err);
        Swal.fire({
          icon: "error",
          title: "Erro ao iniciar pagamento",
          text: err.message || "Tente novamente mais tarde.",
          confirmButtonColor: "#ff6fa7",
        });
      }
    });

    // ================================
    // üöÄ Inicializa resumo
    // ================================
    window.addEventListener("DOMContentLoaded", carregarResumo);
  </script>

  <!-- Bibliotecas -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="script.js"></script>

  <script>
    // ‚úÖ Recarrega navbar e contador
    window.addEventListener("load", () => {
      console.log("üîÅ Recarregando navbar no checkout...");

      // Recarrega categorias e busca
      if (typeof inicializarNavbar === "function") {
        inicializarNavbar();
        console.log("‚úÖ Navbar inicializada no checkout");
      }
      if (typeof inicializarDropdown === "function") inicializarDropdown();

      // Recarrega contador de carrinho
      if (typeof atualizarContadorCarrinho === "function") {
        atualizarContadorCarrinho();
      }

      // Como o checkout n√£o tem bolhas, n√£o chama inicializarBolhas
    });
  </script>
</body>
</html>
