<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalhes do Produto - JF Semi Joias</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="icons/logo.png" />
  <style>
    /* Bot√£o/‚Äúdropdown‚Äù customizado */
    .size-picker-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1.5px solid #ff4b8f;
      background: #fff;
      color: #ff4b8f;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
      transition: transform .08s ease, box-shadow .2s ease, background-color .2s ease;
      box-shadow: 0 4px 12px rgba(255, 75, 143, 0.12);
    }
    .size-picker-btn:hover { transform: translateY(-1px); background-color: #fff6f9; }
    .size-picker-btn span.value { color: #ff2f82; }
    .size-hint { font-size: .9rem; color: #777; margin-top: 6px; }

    /* Chips de tamanho dentro do popup */
    .size-chip {
      display: inline-block;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1.5px solid #ff4b8f;
      color: #ff4b8f;
      font-weight: 600;
      margin: 6px;
      cursor: pointer;
      transition: background-color .15s ease, color .15s ease, transform .05s ease;
      user-select: none;
    }
    .size-chip:hover { background: #ffedf4; }
    .size-chip:active { transform: scale(0.97); }
    .size-chip.selected { background: #ff4b8f; color: #fff; }

    .tamanhos-wrapper { margin: 16px 0 6px; }
  </style>
</head>

<body>
  <!-- üî∏ Barra de categorias e busca -->
  <nav id="faixa-categorias">
    <div class="categorias">
      <a href="#" class="categoria inicio">In√≠cio</a>
      <span class="divisor">|</span>
      <a href="#" class="categoria">Conjuntos</a>
      <span class="divisor">|</span>
      <a href="#" class="categoria">Pulseiras</a>
      <span class="divisor">|</span>
      <a href="#" class="categoria">Brincos</a>
      <span class="divisor">|</span>
      <a href="#" class="categoria">An√©is</a>
    </div>



    <div class="busca">
      <input type="text" placeholder="Digite aqui o que procura..." />
      <button id="botao-buscar" title="Buscar">
        <img src="icons/search.svg" alt="Buscar" width="20" />
      </button>
    </div>
  </nav>

  <!-- üî∏ Cabe√ßalho -->
  <header>
    <h1>JF Semi Joias</h1>
    <p>Detalhes do Produto</p>

    <button id="botao-carrinho" onclick="irParaCarrinho()" title="Carrinho">
      <img src="icons/cart.svg" alt="Carrinho" />
      <span id="contador-carrinho">0</span>
    </button>

    <div id="bolhas-menu">
      <button class="bolha" id="botao-login" title="Entrar / Conta">
        <img src="icons/user.svg" alt="Login" />
      </button>
      <button class="bolha" id="botao-pedidos" title="Meus pedidos">
        <img src="icons/box.svg" alt="Pedidos" />
      </button>
      <button class="bolha" id="botao-favoritos" title="Favoritos">
        <img src="icons/star.svg" alt="Favoritos" />
      </button>
    </div>
  </header>

  <!-- üî∏ Detalhes do produto -->
  <div class="produto-detalhe" id="produto-detalhe">
    <p>Carregando produto...</p>
  </div>

  <!-- üî∏ Rodap√© -->
  <footer>
    <p>¬© 2025 JF Semi Joias - Todos os direitos reservados</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const API = "https://jf-semi-joias-backend.onrender.com";
    let imagens = [];
    let indiceAtual = 0;
    let produtoGlobal = null; // guarda o produto carregado
    let tamanhoSelecionado = null; // tamanho escolhido no popup

    function pegarIdProduto() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    async function carregarProduto() {
      const id = pegarIdProduto();
      const detalheContainer = document.getElementById("produto-detalhe");

      try {
        const resposta = await fetch(`${API}/produtos/${id}`);
        const produto = await resposta.json();
        produtoGlobal = produto;

        if (!produto || !produto.nome) {
          detalheContainer.innerHTML = "<p>Produto n√£o encontrado.</p>";
          return;
        }

        imagens = produto.imagens || [];
        indiceAtual = 0;

        const temTamanhos = (produto.categoria === "aneis") && Array.isArray(produto.tamanhosDisponiveis) && produto.tamanhosDisponiveis.length;

        detalheContainer.innerHTML = `
          <div class="favorito-btn" id="favorito-detalhe" onclick="toggleFavoritoDetalhe()">
            <img src="icons/star.svg" alt="Favoritar" />
          </div>

          <div class="carrossel-container">
            <div class="carousel-track">
              ${imagens.map((img) => `<img src="${img}" class="carousel-img">`).join("")}
            </div>
            <button id="prev">‚ùÆ</button>
            <button id="next">‚ùØ</button>
          </div>

          <h2>${produto.nome}</h2>
          <p class="descricao">${produto.descricao || ""}</p>
          <p class="preco-detalhe">R$ ${Number(produto.preco || 0).toFixed(2)}</p>

          ${temTamanhos ? `
            <div class="tamanhos-wrapper">
              <button id="btn-escolher-tamanho" class="size-picker-btn" type="button">
                <span>${tamanhoSelecionado ? "Tamanho: " : "Escolher tamanho"}</span>
                <span class="value">${tamanhoSelecionado || ""}</span>
              </button>

              <div class="size-hint">Selecione o tamanho antes de comprar.</div>
            </div>
          ` : ""}

          <button class="comprar-btn" id="btn-comprar">Comprar</button>
        `;

        // navega√ß√£o galeria
        document.getElementById("prev").onclick = () => mudarImagem(-1);
        document.getElementById("next").onclick = () => mudarImagem(1);
        ativarSwipe();
        verificarFavorito(produto._id);

        // dropdown / popup de tamanhos
        if (temTamanhos) {
          document.getElementById("btn-escolher-tamanho").addEventListener("click", () => {
            abrirSeletorTamanho(produto.tamanhosDisponiveis).then((t) => {
              if (!t) return;
              tamanhoSelecionado = t;
              const btn = document.getElementById("btn-escolher-tamanho");
              btn.querySelector("span").textContent = "Tamanho: ";
              btn.querySelector(".value").textContent = t;
            });
          });
        }

        // Comprar
        document.getElementById("btn-comprar").addEventListener("click", async () => {
          const token = localStorage.getItem("token");
          if (!token) {
            await Swal.fire({
              icon: "warning",
              title: "Fa√ßa login para comprar",
              confirmButtonText: "Entrar",
              showCancelButton: true,
              confirmButtonColor: "#ff6fa7",
            });
            if (!localStorage.getItem("token")) {
              window.location.href = "login.html";
              return;
            }
          }

          // se for anel, obrigar tamanho
          if (produto.categoria === "aneis") {
            if (!tamanhoSelecionado) {
              const t = await abrirSeletorTamanho(produto.tamanhosDisponiveis);
              if (!t) return;
              tamanhoSelecionado = t;
              const btn = document.getElementById("btn-escolher-tamanho");
              if (btn) {
                btn.querySelector("span").textContent = "Tamanho: ";
                btn.querySelector(".value").textContent = t;
              }
            }
          }

          adicionarAoCarrinho(produto._id, produto.nome, produto.preco, produto.imagens?.[0] || "", 1, tamanhoSelecionado);
        });

      } catch (erro) {
        console.error("Erro ao carregar produto:", erro);
        detalheContainer.innerHTML = "<p>Erro ao carregar produto.</p>";
      }
    }

    // Popup centralizado para tamanhos
    function abrirSeletorTamanho(tamanhos) {
      return new Promise((resolve) => {
        const html = `
          <div style="text-align:center;">
            ${tamanhos.map((t) => `<span class="size-chip" data-size="${t}">${t}</span>`).join("")}
          </div>
        `;
        Swal.fire({
          title: "Escolha o tamanho",
          html,
          showConfirmButton: false,
          showCloseButton: true,
          background: "#fffafc",
          color: "#333",
          width: 480,
          didOpen: () => {
            document.querySelectorAll(".size-chip").forEach(chip => {
              chip.addEventListener("click", () => {
                const valor = chip.getAttribute("data-size");
                // feedback visual
                document.querySelectorAll(".size-chip").forEach(c => c.classList.remove("selected"));
                chip.classList.add("selected");
                setTimeout(() => {
                  Swal.close();
                  resolve(valor);
                }, 120);
              });
            });
          },
          willClose: () => { if (Swal.getHtmlContainer()?.querySelector(".selected") == null) resolve(null); }
        });
      });
    }

    function adicionarAoCarrinho(id, nome, preco, imagem, quantidade = 1, tamanho = null) {
      const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
      carrinho.push({ _id: id, nome, preco, imagem, quantidade, tamanho });
      localStorage.setItem("carrinho", JSON.stringify(carrinho));
      atualizarContadorCarrinho();

      Swal.fire({
        title: "Produto adicionado!",
        html: `
          <img src="${imagem}" alt="${nome}" style="width:120px;border-radius:10px;margin-bottom:15px;">
          <p><b>${nome}</b> foi adicionado ao carrinho.</p>
          ${tamanho ? `<p>Tamanho: <b>${tamanho}</b></p>` : ""}
          <p style="font-size: 16px; margin-top: 8px;">R$ ${Number(preco || 0).toFixed(2)}</p>
        `,
        showCancelButton: true,
        confirmButtonText: "Ir para o carrinho",
        cancelButtonText: "Continuar comprando",
        confirmButtonColor: "#ff6fa7",
        cancelButtonColor: "#aaa",
      }).then((r) => {
        if (r.isConfirmed) window.location.href = "carrinho.html";
      });
    }

    function mudarImagem(direcao) {
      const track = document.querySelector(".carousel-track");
      const total = imagens.length || 1;
      indiceAtual = (indiceAtual + direcao + total) % total;
      track.style.transform = `translateX(-${indiceAtual * 100}%)`;
    }

    function ativarSwipe() {
      const container = document.querySelector(".carrossel-container");
      let startX = 0;
      let dragging = false;

      container.addEventListener("touchstart", (e) => {
        startX = e.touches[0].clientX;
        dragging = true;
      });

      container.addEventListener("touchmove", (e) => {
        if (!dragging) return;
        const diff = e.touches[0].clientX - startX;
        if (Math.abs(diff) > 50) {
          dragging = false;
          diff > 0 ? mudarImagem(-1) : mudarImagem(1);
        }
      });

      container.addEventListener("touchend", () => (dragging = false));
    }

    async function verificarFavorito(id) {
      const token = localStorage.getItem("token");
      if (!token) return;
      try {
        const resp = await fetch(`${API}/users/favoritos`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const favoritos = await resp.json();
        const icone = document.querySelector("#favorito-detalhe img");
        const jaFavoritado = favoritos.some((f) => f._id === id);
        if (jaFavoritado) {
          icone.src = "icons/star-fill.svg";
          document.getElementById("favorito-detalhe").style.background = "#ff6fa7";
        } else {
          icone.src = "icons/star.svg";
          document.getElementById("favorito-detalhe").style.background = "#fff";
        }
      } catch (err) {
        console.error("Erro ao verificar favoritos:", err);
      }
    }

    async function toggleFavoritoDetalhe() {
      const token = localStorage.getItem("token");
      if (!token) {
        Swal.fire({ icon: "warning", title: "Fa√ßa login para favoritar", confirmButtonColor: "#ff6fa7" })
          .then(() => (window.location.href = "login.html"));
        return;
      }
      const id = pegarIdProduto();
      const icone = document.querySelector("#favorito-detalhe img");
      const ativo = icone.src.includes("star-fill");
      try {
        if (ativo) {
          await fetch(`${API}/users/favoritos/${id}`, { method: "DELETE", headers: { Authorization: `Bearer ${token}` }});
          icone.src = "icons/star.svg";
          document.getElementById("favorito-detalhe").style.background = "#fff";
        } else {
          await fetch(`${API}/users/favoritos`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify({ produtoId: id }),
          });
          icone.src = "icons/star-fill.svg";
          document.getElementById("favorito-detalhe").style.background = "#ff6fa7";
        }
      } catch (err) {
        console.error("Erro ao favoritar:", err);
      }
    }

    function atualizarContadorCarrinho() {
      const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
      const el = document.getElementById("contador-carrinho");
      if (el) el.textContent = carrinho.length;
    }

    function irParaCarrinho() { window.location.href = "carrinho.html"; }

    window.addEventListener("DOMContentLoaded", () => {
      carregarProduto();
      atualizarContadorCarrinho();
    });
  </script>

  <script src="script.js"></script>
</body>
</html>
